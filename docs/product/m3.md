# M3 PRD — Facility/Site Context Detection

## Overview
This milestone delivers Feature Slice 3 from the roadmap: detect and display ReserveAmerica facility/site context as the user navigates inside the embedded browser. We parse `facilityId` and `siteId` from the URL and enrich with human‑readable names (facility, location, site) from the page DOM, then surface this information in the sidebar within ~1s of landing on a relevant page.

## Goals
- Extract `facilityId` and `siteId` from ReserveAmerica URLs reliably.
- Enrich with readable labels: facility name, location (e.g., park, state), and site name.
- Update the sidebar automatically on navigation or in‑page route changes (SPA).
- Show clear, debounced status: loading → parsed (partial or full) → unknown (if not on a relevant page).

## Non‑Goals (M3)
- Countdown/prewarm/open‑polling worker (deferred to M4).
- Booking form inputs and validation (deferred to later slice).
- Network calls to RA backend for enrichment (DOM‑only enrichment in M3).
- Persistence of context to disk.

## In‑Scope
1) URL parsing
   - Parse `facilityId` and `siteId` from query parameters or path segments.
   - Handle canonical campsite/detail and date pages; tolerate extra params and fragments.
2) DOM enrichment
   - Read facility name, location, and site name via robust selectors and fallbacks.
   - Permit partial results (e.g., IDs without names) while page loads.
3) Navigation & update model
   - React to `did-navigate`, `did-navigate-in-page`, and SPA history changes.
   - Debounce rapid updates; display results within ~1s.
4) Sidebar presentation
   - Show IDs and labels with clear hierarchy.
   - States: loading, partial, complete, unknown (when not on a campsite context).
5) Resilience
   - Timeouts for DOM lookups; retry briefly after SPA transitions.
   - Guardrails to avoid flashing stale data between navigations.

## Functional Requirements
- Detect context within 1s of reaching a relevant RA page.
- Extract IDs from:
  - Query parameters (e.g., `?facilityId=...&siteId=...`).
  - Path segments (e.g., `/explore/camping/.../<facility-or-site>/...`), with regex fallbacks.
- Enrich with labels from DOM via multiple selectors; sanitize strings (trim, collapse whitespace).
- Trigger detection on:
  - Top‑level navigations and in‑page (SPA) route changes.
  - An explicit “refresh context” action (for manual recovery).
- Sidebar displays:
  - Facility ID, Site ID (when available).
  - Facility name, Location, Site name (when available).
  - Status chip: Loading/Partial/Complete/Unknown.
- No sensitive values are logged or persisted.

## Acceptance Criteria
- Navigating to a campsite/site detail or date page populates IDs and at least one label within ~1s.
- Moving between different sites or dates updates the sidebar automatically without app restart.
- When not on a relevant page, sidebar shows “Unknown” with no stale values.
- Partial results are allowed briefly while enrichment completes, then stabilize without flicker.
- No unhandled errors in logs; UI remains responsive.

## Risks
- RA DOM and URL structures can change; selectors and patterns must be defensive.
- SPA transitions may delay DOM availability; ensure retries with bounded timeouts.
- Some pages may hide site name until scrolled or interacted; accept partial in M3.
- Internationalization or A/B variants could break selectors; maintain multiple fallbacks.

## Out of Scope Follow‑ups
- Optional network enrichment as a backup if DOM selectors fail consistently.
- Persisting last context for quick reference (without sensitive data).
- Exposing “Copy IDs” affordance in the sidebar.


