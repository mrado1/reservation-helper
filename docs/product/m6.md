# M6 — Countdown + Auto-Start and Smart Booking Modes

## Goal
Let users either:
- Add to Cart immediately when the arrival date is within the 9‑month window, or
- Queue the booking when the arrival date is beyond 9 months, with a countdown and auto-start at the right time.

## Primary User Stories
- As a user, when I select a start date within 9 months from today, I want the button to read “Add to Cart” and immediately start polling to add the site to my cart.
- As a user, when I select a start date more than 9 months from today, I want the UI to tell me why I can’t add it now and switch the button to “Queue Cart,” so the app will automatically start polling at the right time.
- As a user, when I click “Queue Cart,” I want the app to verify the expected “arrival day has to be within 9 months” error is returned by the API, then show a live clock and automatically start polling at 08:59:00 on the arrival date.
- As a user, when the add-to-cart succeeds, I want clear confirmation, and I want to be taken to my cart so I can complete checkout.

## Definitions
- 9‑Month Rule: Reserve America enforces that the arrival date must be within 9 months from “today.” Attempts to add beyond this window return an error (e.g., HTTP 417 with message “Your arrival day has to be within 9 Month(s) from today…”).
- Queue Mode: The app is armed to start polling automatically at a defined time before unlock (08:59:00 on the arrival date).
- Facility Time Zone: Initially inferred from the facility’s state (e.g., `contractCode: NY → America/New_York`). If unknown, fall back to the user’s local time zone (document limitation).

## UX Requirements
1. Booking button labeling
   - Within 9 months: Button label = “Add to Cart”
   - Beyond 9 months: Button label = “Queue Cart”
   - Tooltip/Helper explaining why the label changed.
2. Validation message
   - When beyond 9 months, show inline message: “Arrival date is beyond the 9‑month booking window. You can queue this reservation and we’ll start at 08:59:00 on the arrival date.”
3. Queue flow
   - On “Queue Cart” click:
     - Perform a “preflight probe” add‑to‑cart request.
     - Expect RA error indicating 9‑month rule (e.g., HTTP 417 with specific message).
     - If the error matches, show an armed state with:
       - Live clock display (HH:MM:mmm)
       - Target start time shown (“Auto-start at 08:59:00 on <date>”)
     - If the error does not match, show a clear failure reason and do not arm.
4. Auto‑start timing
   - Auto‑start polling at 08:59:00 on the arrival date in the facility’s time zone.
   - The time is displayed and updates in real-time.
5. Success confirmation
   - On success, show a green “Added to Cart” state and automatically navigate the in‑app webview to the cart page.
6. Non‑blocking UI
   - While armed or polling, keep the app responsive; form inputs lock only when actively polling.

## Acceptance Criteria
- Button label reflects 9‑month rule in real time as the user changes the date.
- When beyond 9 months:
  - “Queue Cart” is available with an explanation message.
  - Clicking “Queue Cart” performs a preflight:
    - If the error matches RA’s 9‑month message, the app arms and displays the live clock and target time.
    - If the error does not match, show a clear error and do not arm.
- At 08:59:00 (facility time) on the arrival date, polling starts automatically.
- Success detection is deterministic:
  - A 200 from add‑to‑cart triggers a cart fetch (`GET /shoppingcart/0`) and confirmation:
    - `itemsCount` increases OR `lastChanges.addedItems` is non‑empty OR a new item appears for the target facility/site.
  - On confirmation, the app navigates to the cart page in the webview.
- Errors and edge cases:
  - If cookies expire (401/403), stop with a clear error.
  - If cart is full (“Maximum number of overlapping reservations”), stop with guidance to clear the cart.
  - If the app is closed or the machine sleeps, arms/polling state is not persisted (documented limitation for M6).

## Non‑Goals (M6)
- Payment/checkout automation.
- Cross‑time‑zone robust handling for all states (we’ll begin with a mapping for known states; extended support in later milestones).
- Adaptive rate/backoff strategies (planned for M7).

## Copy Examples
- Beyond 9 months message: “Arrival date is beyond the 9‑month window. We’ll queue this and auto‑start at 08:59:00 on the arrival date.”
- Armed state: “Queued. Auto‑starting at 08:59:00 on <Mon, MMM DD> (<TZ>).”
- Success: “Added to cart! Opening your cart…”

## Analytics/Telemetry (Optional)
- Track armed events, auto‑starts, success confirmations, and reasons for early stop.

## Risks and Mitigations
- Time zone drift or mismatch: Clearly display the target time and time zone; allow manual override in a future milestone.
- RA API behavior variance: We verify success by fetching the cart and confirming item presence, not just trusting the POST body.


