# M5 PRD — In-App Poller (Manual Start)

## Overview
This milestone delivers Feature Slice 5 from the roadmap: a manual-start polling worker that executes add-to-cart requests to Reserve America's API using the user's session cookies. The worker runs with bounded concurrency and configurable cadence, displays deduplicated status updates in the UI, and can be stopped at any time.

## Goals
- Execute Reserve America add-to-cart API calls using validated form data and context
- Provide manual "Start" and "Stop" controls for the polling worker
- Implement bounded concurrency to respect rate limits
- Display real-time, deduplicated status updates in the UI
- Handle success (200 OK) by stopping and showing confirmation
- Handle errors gracefully with clear feedback

## Non-Goals (M5)
- Countdown to target time (deferred to M6)
- Auto-start at specific timestamp (deferred to M6)
- Prewarm logic (deferred to M6)
- Advanced backoff strategies (deferred to M7)
- Settings UI for cadence/concurrency (deferred to M7)
- Cart navigation on success (deferred to M8)
- Persistent logs to disk (deferred to M9)

## In-Scope
1) **Polling worker**
   - Executes add-to-cart POST requests to RA API
   - Uses facility ID, site ID from M3 context
   - Uses start date, nights from M4 booking form
   - Uses idToken and a1Data cookies from M2
   - Bounded concurrency (e.g., max 3 in-flight requests)
   - Configurable cadence (e.g., 100ms between request batches)

2) **UI controls**
   - "Start Polling" button (replaces "Reserve" button when clicked)
   - "Stop Polling" button (visible while polling active)
   - Disabled state when invalid form or missing context
   - Visual feedback (button states, colors)

3) **Status display**
   - Real-time status updates in sidebar
   - Deduplicated messages (only show when status changes)
   - Display: HTTP status code, response message, timestamp
   - Color-coded indicators (success green, error red, pending yellow)
   - Request count and elapsed time

4) **Success detection**
   - Detect HTTP 200 with successful add-to-cart response
   - Stop polling automatically
   - Display success message with next steps
   - Console log for debugging

5) **Error handling**
   - Display error messages from RA API
   - Continue polling on transient errors (429, 503)
   - Stop polling on terminal errors (401, 403, inventory unavailable)
   - Handle network errors gracefully
   - Auto-stop on HTTP 000 (rate limit/blocked)

6) **Safety guardrails**
   - Maximum duration (e.g., 5 minutes, then auto-stop)
   - In-flight request cap (prevent runaway behavior)
   - User can stop at any time
   - Clear feedback on why polling stopped

## Functional Requirements
- Polling worker runs in main process (not renderer)
- Uses `fetch` or `https` module for API calls
- Constructs add-to-cart payload with:
  - facilityId, siteId (from M3 context)
  - arrivalDate (from M4 start date, formatted ISO)
  - nights (from M4 nights input)
  - User's cookies (idToken, a1Data from M2)
- Sends requests with proper headers:
  - `Authorization: Bearer ${idToken}`
  - `Cookie: a1Data=${a1Data}`
  - `Content-Type: application/json`
  - `User-Agent` (mimic browser)
- Polls at configurable cadence (default 100ms between batches)
- Limits in-flight requests (default 3 concurrent)
- Broadcasts status updates via IPC to renderer
- Deduplicates consecutive identical status messages
- Stops on:
  - User click "Stop"
  - Success (200 OK with inventory added)
  - Terminal error (auth fail, inventory unavailable)
  - Maximum duration reached (5 minutes)
  - HTTP 000 (network blocked)

## UI/UX Requirements
- Polling status section in sidebar (below booking form)
- "Start Polling" button replaces "Reserve" when clicked
- "Stop Polling" button appears while active
- Status display shows:
  - Current state (Idle, Polling, Success, Stopped, Error)
  - Last HTTP status code
  - Last response message (truncated if long)
  - Request count (e.g., "142 requests sent")
  - Elapsed time (e.g., "Polling for 23.4s")
  - Timestamp of last update
- Color-coded status chip:
  - Green: Success (200 OK)
  - Red: Error (400+, terminal)
  - Yellow: Polling (active)
  - Gray: Idle/Stopped
- Smooth transitions, no UI jank during polling
- Disable form inputs while polling (prevent changes mid-flight)

## Acceptance Criteria
- Clicking "Start Polling" with valid form and context begins sending requests
- Status updates appear in UI within 200ms of first request
- Requests include correct payload (facility, site, date, nights)
- Requests include user's auth cookies
- HTTP responses logged to console for debugging
- Success (200 OK) stops polling and shows success message
- Terminal errors (401, 403, inventory unavailable) stop polling
- Clicking "Stop Polling" halts worker immediately
- No more than 3 requests in-flight at once (bounded concurrency)
- Requests sent at ~100ms cadence (10 requests/second)
- Auto-stop after 5 minutes if no success
- Auto-stop on HTTP 000 (rate limit)
- UI remains responsive during polling (no freeze)
- Console shows request/response details for debugging

## Edge Cases
- User clicks "Start" with stale context → validation error, no polling
- User navigates away during polling → auto-stop, show warning
- Network disconnect during polling → show error, stop polling
- RA API returns unexpected response format → log error, continue polling
- User clicks "Stop" immediately after "Start" → worker stops cleanly
- Multiple rapid "Start"/"Stop" clicks → debounce, prevent race conditions
- Form changes during polling → ignored (form locked while active)

## Success Metrics (M5)
- Worker sends requests at target cadence (±10%)
- UI updates reflect worker state within 200ms
- No memory leaks or runaway behavior
- User can start/stop reliably
- Success detection works (manual testing against RA)

## API Details (Reserve America Add-to-Cart)

**Endpoint** (example, verify against RA):
```
POST https://www.reserveamerica.com/api/cart/add
```

**Payload** (example structure, adjust as needed):
```json
{
  "facilityId": "140",
  "siteId": "245719",
  "arrivalDate": "2026-05-17",
  "lengthOfStay": 3,
  "cartType": "camping"
}
```

**Headers**:
```
Authorization: Bearer <idToken>
Cookie: a1Data=<urlencoded_a1Data>
Content-Type: application/json
User-Agent: Mozilla/5.0 ...
```

**Expected Responses**:
- `200 OK`: Success, inventory added to cart
- `400 Bad Request`: Invalid payload
- `401 Unauthorized`: Invalid/expired token
- `403 Forbidden`: Auth valid but request denied
- `404 Not Found`: Facility/site not found
- `409 Conflict`: Inventory unavailable
- `429 Too Many Requests`: Rate limited
- `500 Server Error`: RA backend issue
- `503 Service Unavailable`: RA backend overloaded

**Note**: Actual API endpoint and payload structure need to be reverse-engineered from browser DevTools while manually booking. This PRD uses example values.

## Open Questions
- What is the exact RA add-to-cart API endpoint and payload structure?
- What headers are required beyond Authorization and Cookie?
- What response indicates "inventory unavailable" vs "try again"?
- What is RA's rate limit threshold?
- Should we include other parameters (equipment, pets, etc.)?
- What User-Agent string does RA expect?

## Future Enhancements (Post-M5)
- Settings UI to adjust cadence and concurrency
- Visual request rate graph (requests/second over time)
- Export polling logs to file
- "Dry run" mode (validate payload without sending)
- Retry logic with exponential backoff
- Multiple site polling (try multiple sites in parallel)



