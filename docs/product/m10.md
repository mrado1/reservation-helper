# M10 â€” Auto-Updates, Analytics & Remote Control

## Goal
Implement automatic updates, usage analytics, and remote feature control to enable seamless distribution, understand user behavior, and maintain control over the application lifecycle without requiring manual intervention from users.

M10 focuses on **operational infrastructure** that makes the app production-ready for wider distribution while maintaining the ability to monitor usage and remotely disable the app if needed.

## Primary User Stories
- **As a user**, I want the app to automatically update itself so I don't have to manually download and reinstall new versions.
- **As a developer**, I want to see how many people are using the app and which features they use so I can prioritize improvements.
- **As a developer**, I want the ability to remotely disable the app or specific features in case of critical bugs or service issues.
- **As a user**, I want to be notified when updates are available and have them install seamlessly without losing my current session.

## Scope

### In Scope
- **Auto-Updates (electron-updater)**
  - Automatic update checks on app launch
  - Background download of updates
  - User notification when update is ready
  - One-click restart to install update
  - Delta updates (only download changed files)
  - Publish updates via GitHub Releases
  
- **Analytics (PostHog)**
  - Anonymous usage tracking (no PII)
  - Track daily/monthly active users
  - Track feature usage (booking attempts, success/error rates)
  - Geographic distribution (by IP, automatically captured)
  - Session duration and app version tracking
  - Event tracking for key user actions
  
- **Remote Control (PostHog Feature Flags)**
  - Global kill switch to disable entire app
  - Feature-specific flags (disable booking, disable countdown, etc.)
  - Version-based flags (disable old versions)
  - Custom messaging for disabled states
  - Real-time flag updates without code deployment

- **Repository Migration**
  - Move from `SmokeStudio/camping-thing` to personal repo
  - Rename to `reservation-helper`
  - Update all references in code and documentation
  - Preserve git history

### Out of Scope (M10)
- User authentication / login system (future milestone)
- Paid subscription / license management
- Crash reporting (can add Sentry later)
- In-app feedback system
- Multi-language support for notifications
- Custom update channels (beta/stable)

## UX Requirements

### Auto-Update Experience
- **Silent Check**: App checks for updates on launch without blocking the UI
- **Background Download**: Updates download in the background while user continues working
- **Non-Intrusive Notification**: Small notification banner appears when update is ready
  - "Update available - Restart to install" with "Restart Now" and "Later" buttons
  - If user clicks "Later", remind them on next launch
- **Quick Install**: Restart and install should take < 10 seconds
- **No Data Loss**: Current context (facility, site, dates) should persist through update

### Analytics (Invisible to User)
- **Zero User Friction**: No consent dialogs, no visible tracking
- **Privacy-First**: Only track anonymous usage patterns, no personal data
- **No Performance Impact**: Analytics should not slow down the app

### Feature Flags (Invisible Unless Triggered)
- **Graceful Degradation**: If app is disabled, show clear message with contact info
- **Feature-Specific Messages**: If booking is disabled, explain why and when it will be back
- **No Crashes**: App should never crash due to feature flag checks

## Acceptance Criteria

### Auto-Updates
- **Update Detection**
  - [ ] App checks for updates on launch within 5 seconds
  - [ ] Update check does not block app startup
  - [ ] Update check works on both macOS and Windows
  
- **Update Download**
  - [ ] Updates download in background without user intervention
  - [ ] Download progress is visible (optional: show progress bar)
  - [ ] Failed downloads retry automatically
  
- **Update Installation**
  - [ ] User is notified when update is ready to install
  - [ ] "Restart Now" button installs update and relaunches app
  - [ ] "Later" button dismisses notification until next launch
  - [ ] App state (context, form data) persists through update
  
- **Update Publishing**
  - [ ] `npm run publish` builds and uploads to GitHub Releases
  - [ ] Both macOS and Windows builds are published
  - [ ] Release notes are included in GitHub Release
  - [ ] `latest.yml` and `latest-mac.yml` files are generated

### Analytics
- **Tracking Setup**
  - [ ] PostHog SDK is integrated into main and renderer processes
  - [ ] Anonymous machine ID is generated and used consistently
  - [ ] App version and platform are tracked with every event
  
- **Core Events**
  - [ ] `app_launched` - fired on every app start
  - [ ] `booking_started` - fired when user clicks "Add to Cart"
  - [ ] `booking_success` - fired when item added to cart
  - [ ] `booking_error` - fired on booking failure (with error type)
  - [ ] `countdown_armed` - fired when countdown timer is set
  - [ ] `context_refreshed` - fired when user refreshes facility/site
  
- **Metrics Available**
  - [ ] Daily active users (DAU)
  - [ ] Monthly active users (MAU)
  - [ ] Success rate (bookings succeeded / bookings attempted)
  - [ ] Geographic distribution (country/region)
  - [ ] Version adoption (% of users on each version)
  - [ ] Average session duration

### Feature Flags
- **Global Kill Switch**
  - [ ] `app_enabled` flag can disable entire app
  - [ ] Disabled app shows custom message and quits gracefully
  - [ ] Flag check happens on app launch before window creation
  
- **Feature Flags**
  - [ ] `booking_enabled` flag can disable booking functionality
  - [ ] Disabled features show clear message in UI
  - [ ] Flags are checked before each feature use
  
- **Flag Management**
  - [ ] Flags can be toggled in PostHog dashboard
  - [ ] Flag changes take effect within 60 seconds
  - [ ] Failed flag checks default to "enabled" (fail-open)

### Repository Migration
- [ ] Repository renamed to `reservation-helper`
- [ ] All package.json references updated
- [ ] All documentation references updated
- [ ] GitHub repo URL updated in auto-updater config
- [ ] Git history preserved

## Technical Requirements

### Auto-Updater Configuration
```json
{
  "publish": {
    "provider": "github",
    "owner": "your-username",
    "repo": "reservation-helper",
    "private": true,
    "releaseType": "release"
  }
}
```

### PostHog Configuration
- **API Key**: Store in environment variable or config file (not in code)
- **Host**: Use PostHog Cloud (`https://app.posthog.com`) for simplicity
- **Batch Size**: 10 events (reduce API calls)
- **Flush Interval**: 10 seconds (balance between real-time and performance)

### Feature Flag Schema
```javascript
{
  app_enabled: true,           // Global kill switch
  booking_enabled: true,       // Enable/disable booking
  countdown_enabled: true,     // Enable/disable countdown timer
  min_version: "0.1.0",       // Minimum supported version
  message: null                // Custom message for disabled states
}
```

### Privacy & Compliance
- **No PII**: Never track names, emails, addresses, or payment info
- **Anonymous IDs**: Use machine ID (not user-identifiable)
- **Opt-Out**: Provide way to disable analytics in settings (future)
- **Data Retention**: PostHog default (90 days for free tier)

## Risks & Mitigations

### Auto-Update Risks
- **Risk**: Update fails mid-install, leaving app broken
  - **Mitigation**: electron-updater has built-in rollback; keep old version until new one launches successfully
  
- **Risk**: Update downloads large file on metered connection
  - **Mitigation**: Delta updates only download changed files; typical update is < 5MB
  
- **Risk**: GitHub Releases rate limiting
  - **Mitigation**: Use private repo (higher rate limits); cache update metadata

### Analytics Risks
- **Risk**: PostHog API is down, app crashes
  - **Mitigation**: Wrap all analytics calls in try-catch; fail silently
  
- **Risk**: Privacy concerns from users
  - **Mitigation**: Be transparent in docs; only track anonymous usage; provide opt-out

### Feature Flag Risks
- **Risk**: Feature flag API is down, app can't launch
  - **Mitigation**: Fail-open (if flags can't be fetched, assume enabled)
  
- **Risk**: Accidentally disable app for all users
  - **Mitigation**: Test flags on dev builds first; have rollback plan

## Open Questions
- Should we show update changelog to users, or just "Update available"?
  - **Decision**: Show simple "Update available" for now; add changelog in future
  
- Should analytics be opt-in or opt-out?
  - **Decision**: Opt-out by default (standard for desktop apps); add opt-out in settings later
  
- Should we track booking details (facility ID, site ID)?
  - **Decision**: Yes, but only aggregated (no user-specific booking history)
  
- What happens if user is offline when update check runs?
  - **Decision**: Fail silently; check again on next launch

## Success Metrics
- **Auto-Updates**
  - 90%+ of users on latest version within 7 days of release
  - < 1% of update installations fail
  - Average update time < 15 seconds
  
- **Analytics**
  - Successfully track 100% of app launches
  - < 0.1% event drop rate
  - Dashboard loads in < 3 seconds
  
- **Feature Flags**
  - Flag changes propagate to all users within 5 minutes
  - Zero app crashes due to flag checks
  - Kill switch can disable app within 60 seconds

## Implementation Timeline
- **Week 1**: Auto-updater setup and testing
- **Week 2**: PostHog integration and event tracking
- **Week 3**: Feature flags and kill switch
- **Week 4**: Repository migration and final testing

## Dependencies
- `electron-updater` (npm package)
- `posthog-node` (npm package)
- `node-machine-id` (npm package, for anonymous IDs)
- GitHub Personal Access Token (for publishing releases)
- PostHog account (free tier)

## Documentation Updates Required
- Update BUILD.md with publishing instructions
- Update DISTRIBUTION.md with auto-update info
- Create ANALYTICS.md with event catalog
- Update README.md with new repo name and URLs

